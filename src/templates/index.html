<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wi-Fi IDS Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Chart.js -->
  <script src="chart.js"></script>
  <style>
    :root {
      --bg-dark: #050816;
      --bg-card: #0f172a;
      --accent: #3b82f6;
      --accent-soft: rgba(59,130,246,0.2);
      --accent-danger: #ef4444;
      --accent-warning: #eab308;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #1f2933, #020617);
      color: var(--text-main);
    }

    .layout {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 2fr 1.4fr;
      grid-gap: 16px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .status-bar {
      margin-bottom: 16px;
      padding: 14px 18px;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, rgba(15,23,42,0.95), rgba(15,23,42,0.7));
      box-shadow: 0 18px 50px rgba(15,23,42,0.7);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: grey;
    }

    .status-pill.ok      { background: #022c22; color: #6ee7b7; }
    .status-pill.ok .status-dot { background: #22c55e; }

    .status-pill.warn    { background: #422006; color: #facc15; }
    .status-pill.warn .status-dot { background: #facc15; }

    .status-pill.alert   { background: #3f1111; color: #fca5a5; }
    .status-pill.alert .status-dot { background: #ef4444; }

    .status-title {
      font-weight: 600;
      font-size: 15px;
    }

    .status-sub {
      font-size: 13px;
      color: var(--text-muted);
    }

    .cards-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-gap: 12px;
      margin-bottom: 12px;
    }

    @media (max-width: 900px) {
      .cards-row {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 12px 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 25px rgba(15,23,42,0.7);
    }

    .card h3 {
      margin: 0 0 4px 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .card-value {
      font-size: 22px;
      font-weight: 600;
    }

    .card-sub {
      margin-top: 3px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .graph-card {
      height: 360px;
    }

    .alerts-card {
      max-height: 440px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }

    th, td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(31,41,55,0.7);
    }

    th {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.8);
    }

    .alert-kind {
      font-weight: 500;
      font-size: 12px;
    }

    .alert-kind.tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      display: inline-block;
    }

    .pill-danger {
      border-color: rgba(239,68,68,0.7);
      color: #fecaca;
    }

    .pill-info {
      border-color: rgba(59,130,246,0.7);
      color: #bfdbfe;
    }

    .pill-anom {
      border-color: rgba(96,165,250,0.7);
      color: #e0f2fe;
    }

    .timestamp {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .details-cell {
      max-width: 260px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-muted);
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(107,114,128,0.7);
      color: var(--text-muted);
    }

    .badge-critical {
      border-color: rgba(239,68,68,0.7);
      color: #fecaca;
    }

    .badge-high {
      border-color: rgba(249,115,22,0.8);
      color: #fed7aa;
    }

    .badge-normal {
      border-color: rgba(52,211,153,0.8);
      color: #bbf7d0;
    }
  </style>
</head>
<body>
  <div class="status-bar">
    <div>
      <div class="status-title">Wi-Fi Intrusion Detection</div>
      <div class="status-sub" id="status-sub">Waiting for data…</div>
    </div>
    <div>
      <span class="status-pill ok" id="status-pill">
        <span class="status-dot"></span>
        <span id="status-text">Normal</span>
      </span>
      <span class="badge" id="ts-info">—</span>
    </div>
  </div>

  <div class="layout">
    <div>
      <div class="cards-row">
        <div class="card">
          <h3>Deauth / s (window)</h3>
          <div class="card-value" id="card-deauth">0</div>
          <div class="card-sub" id="card-deauth-sub">Top sender: —</div>
        </div>
        <div class="card">
          <h3>Probe Req / s (window)</h3>
          <div class="card-value" id="card-probe">0</div>
          <div class="card-sub">Global burst level</div>
        </div>
        <div class="card">
          <h3>Beacons / s (window)</h3>
          <div class="card-value" id="card-beacon">0</div>
          <div class="card-sub" id="card-beacon-sub">Top channel: —</div>
        </div>
      </div>

      <div class="card graph-card">
        <h3>Traffic over time</h3>
        <canvas id="trafficChart" style="width:100%; height:260px;"></canvas>
      </div>
    </div>

    <div class="card alerts-card">
      <h3>Recent alerts</h3>
      <table>
        <thead>
          <tr>
            <th>Kind</th>
            <th>Window</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="alerts-body">
          <!-- Filled dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:8000/api/state";

    const MAX_POINTS = 60;
    const labels = [];
    const deauthData = [];
    const probeData = [];
    const beaconData = [];

    const ctx = document.getElementById("trafficChart").getContext("2d");
    const trafficChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Deauth",
            data: deauthData,
            borderWidth: 2,
            tension: 0.25,
          },
          {
            label: "Probe",
            data: probeData,
            borderWidth: 2,
            tension: 0.25,
          },
          {
            label: "Beacon",
            data: beaconData,
            borderWidth: 2,
            tension: 0.25,
          },
        ],
      },
      options: {
        plugins: {
          legend: {
            labels: {
              color: "#e5e7eb",
            },
          },
        },
        scales: {
          x: {
            ticks: { color: "#9ca3af", maxTicksLimit: 6 },
            grid: { color: "rgba(31,41,55,0.5)" },
          },
          y: {
            beginAtZero: true,
            ticks: { color: "#9ca3af" },
            grid: { color: "rgba(31,41,55,0.5)" },
          },
        },
      },
    });

    function severityFromAlerts(alerts) {
      if (!alerts || alerts.length === 0) return "normal";
      let critical = false;
      let warning = false;
      const now = Date.now() / 1000;
      for (const a of alerts) {
        const kind = a.kind || "";
        const age = now - (a.ts_to || a.ts_from || 0);
        if (age > 30) continue; // only consider last 30s
        if (kind.startsWith("THRESH_DEAUTH") || kind.includes("EVIL_TWIN")) {
          critical = true;
        } else if (kind.startsWith("ANOMALY_") || kind.includes("PROBE") || kind.includes("BEACON_SPIKE")) {
          warning = true;
        }
      }
      if (critical) return "critical";
      if (warning) return "warning";
      return "normal";
    }

    function updateStatus(sev, metrics) {
      const pill = document.getElementById("status-pill");
      const text = document.getElementById("status-text");
      const sub = document.getElementById("status-sub");

      pill.classList.remove("ok", "warn", "alert");

      if (sev === "critical") {
        pill.classList.add("alert");
        text.textContent = "Intrusion suspected";
        sub.textContent = metrics
          ? "Deauth / evil-twin pattern detected"
          : "Waiting for metrics…";
      } else if (sev === "warning") {
        pill.classList.add("warn");
        text.textContent = "Anomalous activity";
        sub.textContent = metrics
          ? "Probe / beacon anomalies in recent windows"
          : "Waiting for metrics…";
      } else {
        pill.classList.add("ok");
        text.textContent = "Normal";
        sub.textContent = metrics
          ? "No recent threshold / anomaly alerts"
          : "Waiting for metrics…";
      }
    }

    function formatTs(ts) {
      if (!ts) return "—";
      const d = new Date(ts * 1000);
      return d.toLocaleTimeString();
    }

    function updateCards(metrics) {
      const d = metrics ? metrics.deauth : 0;
      const p = metrics ? metrics.probe : 0;
      const b = metrics ? metrics.beacon : 0;

      document.getElementById("card-deauth").textContent = d;
      document.getElementById("card-probe").textContent = p;
      document.getElementById("card-beacon").textContent = b;

      const subDeauth = document.getElementById("card-deauth-sub");
      subDeauth.textContent = metrics
        ? `Top sender burst: ${metrics.top_sender_deauth || 0}`
        : "Top sender: —";

      const subBeacon = document.getElementById("card-beacon-sub");
      subBeacon.textContent = metrics
        ? `Top channel: ${metrics.top_channel ?? "—"} (beacon ${metrics.top_channel_beacon_count || 0})`
        : "Top channel: —";
    }

    function updateChart(tsLabel, metrics) {
      labels.push(tsLabel);
      deauthData.push(metrics ? metrics.deauth : 0);
      probeData.push(metrics ? metrics.probe : 0);
      beaconData.push(metrics ? metrics.beacon : 0);

      if (labels.length > MAX_POINTS) {
        labels.shift();
        deauthData.shift();
        probeData.shift();
        beaconData.shift();
      }
      trafficChart.update();
    }

    function classifyKind(kind) {
      if (!kind) return "info";
      if (kind.startsWith("THRESH_DEAUTH") || kind.includes("EVIL_TWIN")) return "danger";
      if (kind.startsWith("ANOMALY_")) return "anom";
      return "info";
    }

    function updateAlertsTable(alerts) {
      const tbody = document.getElementById("alerts-body");
      tbody.innerHTML = "";

      if (!alerts || alerts.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "No alerts yet.";
        td.style.color = "#6b7280";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const recent = alerts.slice(-20).reverse();

      for (const a of recent) {
        const tr = document.createElement("tr");

        const tdKind = document.createElement("td");
        const spanKind = document.createElement("span");
        spanKind.classList.add("alert-kind", "tag");
        const c = classifyKind(a.kind);
        if (c === "danger") spanKind.classList.add("pill-danger");
        else if (c === "anom") spanKind.classList.add("pill-anom");
        else spanKind.classList.add("pill-info");
        spanKind.textContent = a.kind || "UNKNOWN";
        tdKind.appendChild(spanKind);

        const tdWindow = document.createElement("td");
        const tsFrom = a.ts_from || a.tsTo || 0;
        const tsTo = a.ts_to || a.ts_from || 0;
        const spanWin = document.createElement("div");
        spanWin.classList.add("timestamp");
        spanWin.textContent = `${formatTs(tsFrom)} – ${formatTs(tsTo)}`;
        tdWindow.appendChild(spanWin);

        const tdDetails = document.createElement("td");
        tdDetails.classList.add("details-cell");
        const details = a.details || {};
        tdDetails.textContent = JSON.stringify(details);
        tr.appendChild(tdKind);
        tr.appendChild(tdWindow);
        tr.appendChild(tdDetails);

        tbody.appendChild(tr);
      }
    }

    async function poll() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        if (!data.ok) {
          updateStatus("normal", null);
          document.getElementById("ts-info").textContent = "No data";
          return;
        }

        const metrics = data.metrics;
        const alerts = data.alerts || [];
        const now = data.now || (Date.now() / 1000);

        document.getElementById("ts-info").textContent =
          metrics ? `Window ending: ${formatTs(metrics.ts_to)}` : "No windows yet";

        const sev = severityFromAlerts(alerts);
        updateStatus(sev, metrics);
        updateCards(metrics);

        if (metrics) {
          const label = new Date(metrics.ts_to * 1000).toLocaleTimeString();
          updateChart(label, metrics);
        }

        updateAlertsTable(alerts);
      } catch (e) {
        console.error("poll error", e);
        updateStatus("normal", null);
        document.getElementById("ts-info").textContent = "Disconnected";
      }
    }

    // Poll every second
    poll();
    setInterval(poll, 1000);
  </script>
</body>
</html>
