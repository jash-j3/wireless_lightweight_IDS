<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Network Guardian | IDS Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="chart.js"></script>

  <style>
    :root {
      /* Light Theme Variables */
      --bg-app: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      
      --border-subtle: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

      --color-success: #10b981;
      --color-success-bg: #ecfdf5;
      --color-warning: #f59e0b;
      --color-warning-bg: #fffbeb;
      --color-danger: #ef4444;
      --color-danger-bg: #fef2f2;
      --color-primary: #3b82f6;

      --radius: 12px;
      --font-main: 'Inter', sans-serif;
    }

    /* CRITICAL STATE OVERRIDES (Activated via JS) */
    body.state-critical {
      --bg-app: #fef2f2; /* Light Red Background */
      --border-subtle: #fca5a5;
    }

    body.state-critical .status-bar {
      background: #ef4444;
      color: white;
      border-color: #b91c1c;
      animation: pulse-border 2s infinite;
    }
    
    body.state-critical .status-bar .status-sub {
      color: rgba(255,255,255,0.9);
    }

    body.state-critical .status-pill {
      background: white;
      color: #ef4444;
    }

    body.state-critical .card {
      border-color: #fecaca;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
    }

    @keyframes pulse-border {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      background-color: var(--bg-app);
      color: var(--text-main);
      font-family: var(--font-main);
      transition: background-color 0.5s ease;
    }

    .layout {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* --- Header / Status Bar --- */
    .status-bar {
      padding: 20px 24px;
      border-radius: var(--radius);
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
    }

    .status-content h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .status-sub {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .status-indicator {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Default Pill States (Non-Critical Mode) */
    .pill-normal { background: var(--color-success-bg); color: var(--color-success); border: 1px solid #d1fae5; }
    .pill-warn   { background: var(--color-warning-bg); color: var(--color-warning); border: 1px solid #fef3c7; }
    .pill-alert  { background: var(--color-danger-bg); color: var(--color-danger); border: 1px solid #fee2e2; }

    .refresh-badge {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* --- Mode Toggle --- */
    .mode-toggle-container {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .mode-toggle {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
    }

    .mode-btn {
      border: none;
      background: transparent;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      color: #475569;
      transition: all 0.15s ease;
    }

    .mode-btn.active {
      background: #0f172a;
      color: #f9fafb;
    }

    .mode-btn:hover:not(.active) {
      background: rgba(15, 23, 42, 0.05);
    }

    .mode-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* --- Cards --- */
    .cards-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .cards-row { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      border-color: #cbd5e1;
    }

    .card-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.1;
    }

    .card-meta {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* --- Graph --- */
    .graph-card {
      height: 400px;
      padding-bottom: 40px;
    }

    /* --- Alerts Table --- */
    .alerts-card {
      height: 500px;
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow: hidden;
    }

    .alerts-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      background: #fff;
    }

    .alerts-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .table-container {
      overflow-y: auto;
      flex: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f8fafc;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      text-align: left;
      padding: 12px 20px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      font-weight: 600;
      border-bottom: 1px solid var(--border-subtle);
    }

    td {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-main);
      vertical-align: middle;
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background-color: #f1f5f9; }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      line-height: 1;
    }
    
    .tag-danger { background: var(--color-danger-bg); color: var(--color-danger); border: 1px solid #fee2e2; }
    .tag-anom   { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
    .tag-info   { background: #f3f4f6; color: #64748b; border: 1px solid #e2e8f0; }

    .time-col {
      color: var(--text-secondary);
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
      width: 150px;
    }
    
    .source-col {
      font-family: monospace;
      color: var(--text-main);
      font-size: 12px;
    }

    .metric-col {
        color: var(--text-secondary);
    }
  </style>
</head>
<body>

  <div class="layout">
    
    <div class="status-bar" id="status-container">
      <div class="status-content">
        <h1>Wi-Fi Perimeter Monitor</h1>
        <div class="status-sub" id="status-sub">System initializing...</div>
      </div>
      <div class="status-indicator">
        <div class="status-pill pill-normal" id="status-pill">
          <div class="status-dot"></div>
          <span id="status-text">System Secure</span>
        </div>
        <div class="refresh-badge" id="ts-info">Connecting...</div>

        <!-- Mode toggle + learning info -->
        <div class="mode-toggle-container">
          <div class="mode-toggle">
            <button class="mode-btn active" id="mode-detection">Detection</button>
            <button class="mode-btn" id="mode-learning">Learning</button>
          </div>
          <div class="mode-meta" id="mode-meta">Mode: Detection · baselines frozen</div>
        </div>
      </div>
    </div>

    <div class="cards-row">
      <div class="card">
        <div class="card-label">Deauth Packets / s</div>
        <div class="card-value" id="card-deauth">0</div>
        <div class="card-meta" id="card-deauth-sub">No activity</div>
      </div>
      <div class="card">
        <div class="card-label">Probe Requests / s</div>
        <div class="card-value" id="card-probe">0</div>
        <div class="card-meta">Global burst rate</div>
      </div>
      <div class="card">
        <div class="card-label">Beacons / s</div>
        <div class="card-value" id="card-beacon">0</div>
        <div class="card-meta" id="card-beacon-sub">Scanning channels...</div>
      </div>
    </div>

    <div class="card graph-card">
      <div class="card-label" style="margin-bottom: 16px;">Traffic Analysis (Real-time)</div>
      <div style="position: relative; height: 100%; width: 100%;">
        <canvas id="trafficChart"></canvas>
      </div>
    </div>

    <div class="card alerts-card">
      <div class="alerts-header">
        <h3>Security Events Log</h3>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Severity / Type</th>
              <th>Timestamp</th>
              <th>Target / Source</th>
              <th>Metrics & Thresholds</th>
            </tr>
          </thead>
          <tbody id="alerts-body">
            <tr><td colspan="4" style="text-align:center; padding: 30px; color: var(--text-muted);">Waiting for events...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const API_URL = "http://localhost:8000/api/state";
    const MODE_URL = "http://localhost:8000/api/mode";

    const SUSTAIN_ALERT_MS = 5000;
    let alertExpiryTime = 0; 
    let currentVisualState = 'normal';
    let currentMode = 'detection';

    const MAX_POINTS = 60;
    const labels = [];
    const deauthData = [];
    const probeData = [];
    const beaconData = [];

    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#64748b';
    
    const ctx = document.getElementById("trafficChart").getContext("2d");
    const trafficChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Deauth Attack",
            data: deauthData,
            borderColor: "#ef4444",
            backgroundColor: "rgba(239, 68, 68, 0.1)",
            borderWidth: 2,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 4
          },
          {
            label: "Probe Request",
            data: probeData,
            borderColor: "#3b82f6",
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 0
          },
          {
            label: "Beacon Frame",
            data: beaconData,
            borderColor: "#10b981",
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 0
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
          legend: {
            position: 'top',
            align: 'end',
            labels: { usePointStyle: true, boxWidth: 8, padding: 20 }
          },
          tooltip: {
            backgroundColor: '#1e293b',
            padding: 12,
            cornerRadius: 8,
            titleFont: { weight: '600' }
          }
        },
        scales: {
          x: {
            grid: { display: false, drawBorder: false },
            ticks: { maxTicksLimit: 6, maxRotation: 0 }
          },
          y: {
            beginAtZero: true,
            border: { display: false },
            grid: { color: '#f1f5f9', borderDash: [5, 5] }
          },
        },
      },
    });

    function determineSeverity(alerts) {
      if (!alerts || alerts.length === 0) return "normal";
      
      const now = Date.now() / 1000;
      let critical = false;
      let warning = false;

      for (const a of alerts) {
        const kind = a.kind || "";
        const ts = a.ts_to || a.ts_from || 0;
        if ((now - ts) > 15) continue; 

        if (kind.startsWith("THRESH_DEAUTH") || kind.includes("EVIL_TWIN")) {
          critical = true;
        } else if (kind.startsWith("ANOMALY_") || kind.includes("PROBE") || kind.includes("BEACON_SPIKE")) {
          warning = true;
        }
      }

      if (critical) return "critical";
      if (warning) return "warning";
      return "normal";
    }

    function updateVisualState(calculatedSeverity, metrics) {
      const now = Date.now();

      if (calculatedSeverity === 'critical') {
        alertExpiryTime = now + SUSTAIN_ALERT_MS;
      }

      let displaySeverity = calculatedSeverity;
      if (now < alertExpiryTime) {
        displaySeverity = 'critical';
      }

      const body = document.body;
      const pill = document.getElementById("status-pill");
      const text = document.getElementById("status-text");
      const sub = document.getElementById("status-sub");

      body.classList.remove('state-critical');
      pill.className = "status-pill";

      if (displaySeverity === "critical") {
        body.classList.add('state-critical');
        pill.classList.add("pill-alert"); 
        text.textContent = "INTRUSION DETECTED";
        sub.textContent = "Active Deauthentication or Evil Twin signature matching.";
      } else if (displaySeverity === "warning") {
        pill.classList.add("pill-warn");
        text.textContent = "Anomalous Traffic";
        sub.textContent = "Elevated probe requests or beacon spikes detected.";
      } else {
        pill.classList.add("pill-normal");
        text.textContent = "System Secure";
        // Mode-specific hint appended to normal text via updateModeUI
      }
    }

    function formatTs(ts) {
      if (!ts) return "—";
      const d = new Date(ts * 1000);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function updateCards(metrics) {
      const d = metrics ? metrics.deauth : 0;
      const p = metrics ? metrics.probe : 0;
      const b = metrics ? metrics.beacon : 0;

      document.getElementById("card-deauth").textContent = d.toLocaleString();
      document.getElementById("card-probe").textContent = p.toLocaleString();
      document.getElementById("card-beacon").textContent = b.toLocaleString();

      const subDeauth = document.getElementById("card-deauth-sub");
      subDeauth.innerHTML = (metrics && metrics.top_sender_deauth > 0)
        ? `<span style="color:var(--color-danger)">▲ ${metrics.top_sender_deauth} burst</span>`
        : "Stable";

      const subBeacon = document.getElementById("card-beacon-sub");
      subBeacon.textContent = metrics
        ? `Ch ${metrics.top_channel ?? "—"} active (${metrics.top_channel_beacon_count || 0})`
        : "Scanning...";
    }

    function updateChartData(tsLabel, metrics) {
      labels.push(tsLabel);
      deauthData.push(metrics ? metrics.deauth : 0);
      probeData.push(metrics ? metrics.probe : 0);
      beaconData.push(metrics ? metrics.beacon : 0);

      if (labels.length > MAX_POINTS) {
        labels.shift();
        deauthData.shift();
        probeData.shift();
        beaconData.shift();
      }
      trafficChart.update('none');
    }

    function updateAlertsTable(alerts) {
      const tbody = document.getElementById("alerts-body");
      
      if (!alerts || alerts.length === 0) {
        if (tbody.childElementCount === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 30px; color: var(--text-muted);">No recent security events.</td></tr>`;
        }
        return;
      }

      tbody.innerHTML = "";
      const recent = alerts.slice(-30).reverse();

      for (const a of recent) {
        const tr = document.createElement("tr");
        const details = a.details || {};
        
        const tdKind = document.createElement("td");
        const spanKind = document.createElement("span");
        spanKind.classList.add("tag");
        const kind = a.kind || "UNKNOWN";
        
        if (kind.startsWith("THRESH_DEAUTH") || kind.includes("EVIL_TWIN")) {
          spanKind.classList.add("tag-danger");
          spanKind.innerHTML = `⚠️ ${kind.replace("THRESH_", "").replace("ANOMALY_", "")}`;
        } else if (kind.startsWith("ANOMALY_")) {
          spanKind.classList.add("tag-anom");
          spanKind.textContent = kind.replace("ANOMALY_", "");
        } else {
          spanKind.classList.add("tag-info");
          spanKind.textContent = kind;
        }
        tdKind.appendChild(spanKind);

        const tdTime = document.createElement("td");
        tdTime.className = "time-col";
        const tsTo = a.ts_to || a.ts_from || 0;
        tdTime.textContent = formatTs(tsTo);

        const tdSource = document.createElement("td");
        tdSource.className = "source-col";
        if (details.sender_mac) {
          tdSource.innerHTML = `<span style="color:var(--text-muted)">Sender:</span> ${details.sender_mac}`;
        } else if (details.bssid) {
          tdSource.innerHTML = `<span style="color:var(--text-muted)">BSSID:</span> ${details.bssid}`;
        } else {
          tdSource.textContent = "—";
        }

        const tdMetrics = document.createElement("td");
        tdMetrics.className = "metric-col";
        let metricText = "";
        if (details.count_in_window !== undefined) {
          metricText = `<strong>${details.count_in_window}</strong> pkts (Limit: ${details.threshold})`;
        } else if (details.z !== undefined) {
          metricText = `<strong>Z: ${details.z.toFixed(2)}</strong> (Limit: ${details.z_threshold})`;
        } else if (details.count !== undefined) {
          metricText = `Count: ${details.count}`;
        }
        tdMetrics.innerHTML = metricText;

        tr.appendChild(tdKind);
        tr.appendChild(tdTime);
        tr.appendChild(tdSource);
        tr.appendChild(tdMetrics);
        tbody.appendChild(tr);
      }
    }

    function updateModeUI(mode, learning) {
      currentMode = mode || 'detection';

      const btnDet = document.getElementById('mode-detection');
      const btnLearn = document.getElementById('mode-learning');
      const meta = document.getElementById('mode-meta');
      const sub = document.getElementById('status-sub');

      btnDet.classList.toggle('active', currentMode === 'detection');
      btnLearn.classList.toggle('active', currentMode === 'learning');

      if (!learning) {
        if (currentMode === 'learning') {
          meta.textContent = "Mode: Learning · collecting baseline statistics";
          if (!document.body.classList.contains('state-critical')) {
            sub.textContent = "Learning baselines from current traffic.";
          }
        } else {
          meta.textContent = "Mode: Detection · baselines frozen";
          if (!document.body.classList.contains('state-critical')) {
            sub.textContent = "Monitoring wireless spectrum. No threats found.";
          }
        }
        return;
      }

      const lw = learning.learn_windows || 0;
      const rej = learning.learn_rejected_suspicious || 0;

      if (currentMode === 'learning') {
        meta.textContent = `Mode: Learning · accepted windows: ${lw} · rejected suspicious: ${rej}`;
        if (!document.body.classList.contains('state-critical')) {
          sub.textContent = "Learning baselines from traffic (safe windows only).";
        }
      } else {
        meta.textContent = `Mode: Detection · learner windows: ${lw} (rejected: ${rej})`;
        if (!document.body.classList.contains('state-critical')) {
          sub.textContent = "Monitoring wireless spectrum. Baselines fixed to last calibration.";
        }
      }
    }

    async function changeMode(mode) {
      try {
        await fetch(MODE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode }),
        });
        // Optimistically update UI; poll() will confirm
        updateModeUI(mode, null);
      } catch (e) {
        console.error("Failed to set mode", e);
      }
    }

    async function poll() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        
        if (!data.ok) {
          document.getElementById("ts-info").textContent = "API Idle";
          return;
        }

        const metrics = data.metrics;
        const alerts = data.alerts || [];
        const mode = data.mode || "detection";
        const learning = data.learning || null;

        document.getElementById("ts-info").textContent = 
          metrics ? `Last updated: ${formatTs(metrics.ts_to)}` : "Live";

        const severity = determineSeverity(alerts);
        updateVisualState(severity, metrics);

        updateCards(metrics);

        if (metrics) {
          const label = new Date(metrics.ts_to * 1000).toLocaleTimeString([],{minute:'2-digit', second:'2-digit'});
          updateChartData(label, metrics);
        }

        updateAlertsTable(alerts);
        updateModeUI(mode, learning);

      } catch (e) {
        console.error("poll error", e);
        document.getElementById("ts-info").textContent = "Connection Lost";
        document.getElementById("status-sub").textContent = "Cannot reach IDS server.";
        const pill = document.getElementById("status-pill");
        pill.classList.remove("pill-alert", "pill-warn", "pill-normal");
        pill.style.background = "#e2e8f0";
        pill.style.color = "#64748b";
        document.getElementById("status-text").textContent = "Offline";
      }
    }

    // Attach mode button handlers
    document.getElementById('mode-detection').addEventListener('click', () => {
      if (currentMode !== 'detection') changeMode('detection');
    });
    document.getElementById('mode-learning').addEventListener('click', () => {
      if (currentMode !== 'learning') changeMode('learning');
    });

    poll();
    setInterval(poll, 1000);
  </script>
</body>
</html>
